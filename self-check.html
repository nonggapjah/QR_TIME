<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ลงเวลา (Self Check-in)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;line-height:1.5;margin:0;background:#f7f7f8;color:#111}
    .wrap{max-width:560px;margin:0 auto;padding:20px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.05);padding:18px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button{font-size:16px;border-radius:12px;padding:10px 14px;border:1px solid #d1d5db}
    button{cursor:pointer}
    .primary{background:#111;color:#fff;border-color:#111}
    .muted{color:#6b7280}
    .ok{color:#0a7a0a}
    .bad{color:#b00020}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #e5e7eb;background:#fafafa}
  </style>
</head>
<body>
<div class="wrap">
  <h2>ลงเวลา <span id="title" class="pill">...</span></h2>
  <p class="muted">สำหรับพนักงานลงเวลาเองด้วยมือถือ</p>

  <div class="card">
    <div id="who" class="mt8 muted">ยังไม่ได้บันทึก รหัสพนักงาน</div>
    <div id="first-time" class="mt12">
      <label>รหัสพนักงาน (ครั้งแรกครั้งเดียว):</label>
      <div class="row mt8">
        <input id="empid" placeholder="เช่น E001" maxlength="40">
        <button id="save">บันทึก</button>
        <button id="clear" title="ลบรหัสพนักงานที่จำไว้">ลบ</button>
      </div>
    </div>

    <div class="mt16">
      <button id="btn" class="primary">ยืนยันลงเวลา</button>
    </div>
    <div id="status" class="mt12"></div>

    <details class="mt16">
      <summary>แสดงรายละเอียดอุปกรณ์/พิกัด (เพื่อความโปร่งใส)</summary>
      <pre id="debug" class="muted" style="white-space:pre-wrap"></pre>
    </details>
  </div>

  <p class="muted mt16">หมายเหตุ: หน้านี้รองรับพารามิเตอร์ URL เช่น <code>?action=IN</code> หรือ <code>?action=OUT</code> และ <code>?api=...</code> เพื่อกำหนด API URL ขณะใช้งาน</p>
</div>

<script>
// ===== CONFIG =====
// 1) แก้ค่านี้ให้เป็น Web App URL ของ Google Apps Script ของคุณ
const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbyVrWu-I3NXkVgehrnwfAhXXrr2Xy-1Dp9oA3ITu8Mb5f5IkjusxGN6pzc9tvauGvvS/exec"
// ===== RUNTIME =====
const params = new URLSearchParams(location.search);
const actionParam = (params.get('action')||'IN').toUpperCase();
const action = (actionParam === 'OUT') ? 'OUT' : 'IN';
const API_URL = params.get('api') ? decodeURIComponent(params.get('api')) : DEFAULT_API_URL;

document.getElementById('title').textContent = action === 'IN' ? 'เข้า (IN)' : 'ออก (OUT)';

const elEmp = document.getElementById('empid');
const elWho = document.getElementById('who');
const elFirst = document.getElementById('first-time');
const elSave = document.getElementById('save');
const elClear = document.getElementById('clear');
const elBtn = document.getElementById('btn');
const elStatus = document.getElementById('status');
const elDebug = document.getElementById('debug');

function toast(msg, ok=true){ elStatus.innerHTML = '<div class="' + (ok?'ok':'bad') + '">' + msg + '</div>'; }

function getEmpId(){ return localStorage.getItem('empid') || ''; }
function setEmpId(v){ localStorage.setItem('empid', v); }
function clearEmpId(){ localStorage.removeItem('empid'); }

function paintWho(){
  const id = getEmpId();
  elWho.textContent = id ? ('พนักงาน: ' + id) : 'ยังไม่ได้บันทึก รหัสพนักงาน';
  elFirst.style.display = id ? 'none' : 'block';
}

async function getGeo() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      (pos)=> resolve({lat: pos.coords.latitude, lng: pos.coords.longitude}),
      ()=> resolve(null),
      {enableHighAccuracy:true, timeout: 5000}
    );
  });
}

elSave.onclick = ()=>{
  const v = (elEmp.value||'').trim();
  if(!v){ toast('กรุณาใส่รหัสพนักงาน', false); return; }
  setEmpId(v);
  paintWho();
  toast('บันทึกแล้ว');
};

elClear.onclick = ()=>{
  clearEmpId();
  paintWho();
  toast('ลบแล้ว');
};

elBtn.onclick = async ()=>{
  const empid = getEmpId();
  if(!empid){ toast('ยังไม่มีรหัสพนักงาน', false); return; }
  if(!API_URL || API_URL.includes('REPLACE_WITH_YOUR_APPS_SCRIPT_URL')){
    toast('ยังไม่ได้ตั้งค่า API URL (DEFAULT_API_URL) หรือ ?api=', false); return;
  }
  const geo = await getGeo();
  const payload = { qrPayload: `EMP|${empid}`, action, device: navigator.userAgent, geo };
  // debug info
  elDebug.textContent = JSON.stringify(payload, null, 2);

  try{
    const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if(data.ok){
      toast(`บันทึกสำเร็จ: ${data.employee.EmployeeID} (${data.action})`);
      beep(true);
    } else {
      toast(`ผิดพลาด: ${data.error||'Unknown'}`, false);
      beep(false);
    }
  }catch(err){
    toast('เครือข่ายผิดพลาด: ' + err, false);
    beep(false);
  }
};

// Simple success/fail beep using WebAudio (no external files)
let ctx;
function beep(ok=true){
  try{
    ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = ok ? 'triangle' : 'sawtooth';
    const now = ctx.currentTime;
    const dur = 0.18;
    o.frequency.value = ok ? 880 : 220;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.2, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
    o.start(now); o.stop(now + dur);
  }catch(_){}
}

// init
paintWho();
</script>
</body>
</html>
