<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>สแกน QR ลงเวลา</title>
  <style>
    :root{--bg:#f7f7f8;--fg:#111;--muted:#6b7280;--ok:#0a7a0a;--bad:#b00020;--card:#fff;--bd:#e5e7eb;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;background:var(--bg);color:var(--fg);}
    .wrap{max-width:640px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:0 4px 16px rgba(0,0,0,.05);padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button{padding:10px 14px;border-radius:12px;border:1px solid var(--bd);background:#fff;cursor:pointer}
    .primary{background:#111;color:#fff;border-color:#111}
    .muted{color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt24{margin-top:24px}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--bd);background:#fafafa}
    #reader{width:100%;max-width:520px;margin:12px auto}
  </style>
  <script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
<div class="wrap">
  <h2>สแกน QR ลงเวลา <span id="title" class="pill">...</span></h2>
  <p class="muted">ยกกล้องส่อง QR ของพนักงาน ระบบจะบันทึกเข้า Google Sheet อัตโนมัติ</p>

  <div class="card">
    <div class="row">
      <button id="btn-in">โหมด: เข้า (IN)</button>
      <button id="btn-out">สลับเป็น ออก (OUT)</button>
      <button id="btn-flip" title="สลับกล้องหน้า/หลัง">สลับกล้อง</button>
      <button id="btn-torch" title="ไฟฉาย">ไฟฉาย</button>
    </div>
    <div id="reader"></div>
    <div id="status" class="mt8"></div>
    <details class="mt12">
      <summary>รายละเอียด (ดีบัก)</summary>
      <pre id="debug" class="muted" style="white-space:pre-wrap"></pre>
    </details>
  </div>

  <p class="muted mt12">กำหนดค่าผ่าน URL ได้: <code>?action=IN|OUT</code>, <code>?api=...</code> (Apps Script URL), <code>?qrprefix=EMP|</code></p>
</div>

<script>
// ===== CONFIG =====
const DEFAULT_API_URL = "https://script.google.com/macros/s/AKfycbzaTBA0ZzEUhaBy9i5VBJulwa7Mbsps_m1pLuW1MLn-Yu2bjJenZrzOupYL46TUW7RT/exec";
const DEFAULT_QR_PREFIX = "EMP|"; // QR ที่พนักงานถือควรมีรูปแบบ EMP|<EmployeeID>

// ===== PARAMS =====
const Q = new URLSearchParams(location.search);
const lockedAction = (Q.get('action')||'').toUpperCase();
const QR_PREFIX = Q.get('qrprefix') ? decodeURIComponent(Q.get('qrprefix')) : DEFAULT_QR_PREFIX;
const API_URL = Q.get('api') ? decodeURIComponent(Q.get('api')) : DEFAULT_API_URL;

let currentAction = (lockedAction === 'IN' || lockedAction === 'OUT') ? lockedAction : 'IN';

// ===== UI =====
const elTitle = document.getElementById('title');
const elStatus = document.getElementById('status');
const elDebug = document.getElementById('debug');
const btnIn = document.getElementById('btn-in');
const btnOut = document.getElementById('btn-out');
const btnFlip = document.getElementById('btn-flip');
const btnTorch = document.getElementById('btn-torch');
const readerDiv = document.getElementById('reader');

function paintTitle(){
  elTitle.textContent = currentAction==='IN' ? 'เข้า (IN)' : 'ออก (OUT)';
}
function toast(msg, ok=true){ elStatus.innerHTML = '<div class="' + (ok?'ok':'bad') + '">' + msg + '</div>'; }

// Lock action if provided
if (lockedAction==='IN' || lockedAction==='OUT'){
  btnIn.style.display = 'none';
  btnOut.style.display = 'none';
}
btnIn.onclick = ()=>{ currentAction='IN'; btnIn.disabled=true; btnOut.disabled=false; paintTitle(); toast('โหมดเข้างาน (IN)'); }
btnOut.onclick = ()=>{ currentAction='OUT'; btnOut.disabled=true; btnIn.disabled=false; paintTitle(); toast('โหมดออกงาน (OUT)'); }
btnIn.disabled = currentAction==='IN';
btnOut.disabled = currentAction==='OUT';
paintTitle();

// ===== GEO =====
async function getGeo() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) return resolve(null);
    navigator.geolocation.getCurrentPosition(
      (pos)=> resolve({lat: pos.coords.latitude, lng: pos.coords.longitude}),
      ()=> resolve(null),
      {enableHighAccuracy:true, timeout: 5000}
    );
  });
}

// ===== Wake Lock (กันจอดับ) =====
let wakeLock;
async function keepAwake(){
  try{ wakeLock = await navigator.wakeLock.request('screen'); }catch(_){}
}
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'visible') keepAwake();
});
keepAwake();

// ===== Scanner =====
let html5QrCode;
let currentCameraId = null;
let cameras = [];
let torchOn = false;

async function initScanner(){
  html5QrCode = new Html5Qrcode('reader');
  cameras = await Html5Qrcode.getCameras();
  if(!cameras || !cameras.length){
    toast('ไม่พบกล้องบนอุปกรณ์', false); return;
  }
  // เลือกกล้องหลังถ้าเจอ
  const back = cameras.find(c=>/back|rear|environment/i.test(c.label));
  currentCameraId = (back && back.id) || cameras[0].id;
  await startCamera(currentCameraId);
}

async function startCamera(cameraId){
  await html5QrCode.start(
    { deviceId: { exact: cameraId } },
    { fps: 12, qrbox: { width: 280, height: 280 }, aspectRatio: 1.777 },
    onScanSuccess,
    onScanFailure
  );
  toast('พร้อมสแกนแล้ว');
}

btnFlip.onclick = async ()=>{
  if(!cameras.length) return;
  const idx = cameras.findIndex(c=>c.id===currentCameraId);
  const next = cameras[(idx+1) % cameras.length];
  try{
    await html5QrCode.stop();
    await html5QrCode.clear();
    currentCameraId = next.id;
    await startCamera(currentCameraId);
  }catch(e){ toast('สลับกล้องไม่สำเร็จ: '+e, false); }
};

// Torch (ถ้ารองรับ)
btnTorch.onclick = async ()=>{
  try{
    const track = html5QrCode.getRunningTrackCameraCapabilities();
    if(!track || !track.torch || !track.torch.isPresent) throw new Error('ไม่รองรับไฟฉาย');
    torchOn = !torchOn;
    await html5QrCode.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
    toast(torchOn?'เปิดไฟฉาย':'ปิดไฟฉาย');
  }catch(e){ toast('ใช้ไฟฉายไม่ได้: '+ e.message, false); }
};

let lastScanAt = 0;
const COOLDOWN_MS = 1200; // กันยิงซ้ำเร็วเกิน

function onScanFailure(_) {
  // ปล่อยผ่าน (ไม่แสดง error ทุกเฟรม)
}

async function onScanSuccess(decodedText) {
  const now = Date.now();
  if (now - lastScanAt < COOLDOWN_MS) return;
  lastScanAt = now;

  const text = (decodedText||'').trim();
  elDebug.textContent = 'QR: ' + text;

  if(!text.startsWith(QR_PREFIX)){
    toast(`รูปแบบ QR ไม่ถูกต้อง (ต้องขึ้นต้นด้วย "${QR_PREFIX}")`, false);
    beep(false);
    return;
  }

  const geo = await getGeo();
  const body = { qrPayload: text, action: currentAction, device: navigator.userAgent, geo };

  if(!API_URL || API_URL.includes('REPLACE_WITH_YOUR_APPS_SCRIPT_URL')){
    toast('ยังไม่ได้ตั้งค่า API URL (DEFAULT_API_URL) หรือ ?api=', false);
    beep(false);
    return;
  }

  try{
    const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const data = await res.json();
    if(data.ok){
      toast(`บันทึกสำเร็จ: ${data.employee.EmployeeID} - ${data.employee.Name} (${data.action})`);
      beep(true);
    }else{
      toast(`ผิดพลาด: ${data.error||'Unknown'}`, false);
      beep(false);
    }
  }catch(err){
    toast('เครือข่ายผิดพลาด: ' + err, false);
    beep(false);
  }
}

// Simple beep
let ctx;
function beep(ok=true){
  try{
    ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator(), g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = ok ? 'triangle' : 'sawtooth';
    const now = ctx.currentTime, dur = 0.18;
    o.frequency.value = ok ? 880 : 220;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.2, now + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + dur);
    o.start(now); o.stop(now + dur);
  }catch(_){}
}

window.addEventListener('load', initScanner);
</script>
</body>
</html>
